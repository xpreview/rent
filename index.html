<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monthly Room Rental Register</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px #ccc;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 10px #ccc;
      font-size: 13px;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üìÜ Monthly Room Rental Register</h1>

  <form id="tenantForm">
    <label>Tenant Name</label>
    <input type="text" id="name" required />
    <label>Room Number</label>
    <input type="text" id="room" required />
    <label>Monthly Rent (‚Çπ)</label>
    <input type="number" id="rent" required />
    <label>Electricity Rate (‚Çπ/unit)</label>
    <input type="number" id="rate" required value="10" />
    <label>Check-in Date</label>
    <input type="date" id="checkin" required />
    <button type="submit">Add Tenant</button>
  </form>

  <div id="tenantList"></div>

  <script>
  const form = document.getElementById("tenantForm");
  const tenantList = document.getElementById("tenantList");
  let tenants = JSON.parse(localStorage.getItem("monthlyTenants") || "[]");

  function saveData() {
    localStorage.setItem("monthlyTenants", JSON.stringify(tenants));
  }

  function monthDiff(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    let count = 0;
    while (true) {
      const next = new Date(start);
      next.setMonth(start.getMonth() + count + 1); // start from next month
      if (next > end) break;
      count++;
    }
    return count;
  }

  function formatFullDate(base, offset) {
    const d = new Date(base);
    d.setMonth(d.getMonth() + offset + 1);
    return d.toLocaleDateString("en-IN", { day: '2-digit', month: 'long', year: 'numeric' });
  }

  function getMonthKey(base, offset) {
    const d = new Date(base);
    d.setMonth(d.getMonth() + offset + 1);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
  }

  function ensureAllMonths() {
    const today = new Date();
    tenants.forEach((tenant) => {
      if (!tenant.monthlyData) tenant.monthlyData = {};
      const checkin = new Date(tenant.checkin);
      const total = monthDiff(checkin, today);
      for (let i = 0; i < total; i++) {
        const key = getMonthKey(checkin, i);
        if (!tenant.monthlyData[key]) {
          tenant.monthlyData[key] = {
            rentPaid: false,
            elecStart: "",
            elecEnd: "",
            elecPaid: false
          };
        }
      }
    });
    saveData();
  }

  function renderTenants() {
    tenantList.innerHTML = "";

    tenants.forEach((tenant, index) => {
      const div = document.createElement("div");
      div.style.marginBottom = "30px";

      const checkinDate = new Date(tenant.checkin);
      const checkinText = checkinDate.toLocaleDateString("en-IN", { day: '2-digit', month: 'short' });

      const title = document.createElement("h3");
      title.innerHTML = `üè† ${tenant.name} | Room ${tenant.room}
        <button onclick="deleteTenant(${index})" style="margin-left:20px; background:#dc3545; color:white; padding:4px 10px; border:none; border-radius:4px; font-size:12px; cursor:pointer;">Delete</button>`;
      div.appendChild(title);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Month<br><small>(Joined on ${checkinText})</small></th>
          <th>Rent Paid?</th>
          <th>Elec Start</th>
          <th>Elec End</th>
          <th>Units</th>
          <th>Bill</th>
          <th>Elec Paid?</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const checkin = new Date(tenant.checkin);
      const today = new Date();
      const totalMonths = monthDiff(checkin, today);

      for (let i = 0; i < totalMonths; i++) {
        const key = getMonthKey(checkin, i);
        const label = formatFullDate(checkin, i);
        const data = tenant.monthlyData[key] || {
          rentPaid: false,
          elecStart: "",
          elecEnd: "",
          elecPaid: false
        };

        const start = parseInt(data.elecStart || 0);
        const end = parseInt(data.elecEnd || 0);
        const units = Math.max(0, end - start);
        const bill = units * tenant.rate;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${label}</td>
          <td>
            <input type="checkbox" ${data.rentPaid ? "checked" : ""} 
              onchange="togglePaid(${index}, '${key}', 'rentPaid', this.checked)">
            <br><small>‚Çπ${tenant.rent}</small>
          </td>
          <td><input type="number" value="${data.elecStart}" data-i="${index}" data-month="${key}" data-key="elecStart" class="elecField"></td>
          <td><input type="number" value="${data.elecEnd}" data-i="${index}" data-month="${key}" data-key="elecEnd" class="elecField"></td>
          <td>${units}</td>
          <td>‚Çπ${bill}</td>
          <td><input type="checkbox" ${data.elecPaid ? "checked" : ""} 
              onchange="togglePaid(${index}, '${key}', 'elecPaid', this.checked)"></td>
        `;
        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      div.appendChild(table);
      tenantList.appendChild(div);
    });

    bindInstantElectricityInputs();
  }

  function bindInstantElectricityInputs() {
    document.querySelectorAll('.elecField').forEach(input => {
      input.addEventListener('input', (e) => {
        const i = parseInt(e.target.dataset.i);
        const key = e.target.dataset.key;
        const month = e.target.dataset.month;
        const value = e.target.value;

        tenants[i].monthlyData[month][key] = value;
        saveData();

        // Update units and bill instantly
        const data = tenants[i].monthlyData[month];
        const start = parseInt(data.elecStart || 0);
        const end = parseInt(data.elecEnd || 0);
        const units = Math.max(0, end - start);
        const bill = units * tenants[i].rate;

        const rows = tenantList.querySelectorAll("div")[i].querySelectorAll("tbody tr");
        rows.forEach(row => {
          if (row.cells[0].innerText === formatFullDate(tenants[i].checkin, getMonthOffset(tenants[i].checkin, month))) {
            row.cells[4].innerText = units;
            row.cells[5].innerText = `‚Çπ${bill}`;
          }
        });
      });
    });
  }

  function getMonthOffset(checkin, monthKey) {
    const check = new Date(checkin);
    const [y, m] = monthKey.split('-').map(Number);
    const date = new Date(y, m - 1);
    let offset = 0;
    while (true) {
      const next = new Date(check);
      next.setMonth(check.getMonth() + offset + 1);
      if (next.getFullYear() === date.getFullYear() && next.getMonth() === date.getMonth()) break;
      offset++;
    }
    return offset;
  }

  function togglePaid(index, month, key, checked) {
    tenants[index].monthlyData[month][key] = checked;
    saveData();
    renderTenants();
  }

  form.onsubmit = (e) => {
    e.preventDefault();
    const tenant = {
      name: document.getElementById("name").value,
      room: document.getElementById("room").value,
      rent: parseInt(document.getElementById("rent").value),
      rate: parseFloat(document.getElementById("rate").value),
      checkin: document.getElementById("checkin").value,
      monthlyData: {}
    };
    tenants.push(tenant);
    saveData();
    ensureAllMonths();
    renderTenants();
    form.reset();
  };

  function deleteTenant(index) {
    if (confirm("Are you sure you want to delete this tenant?")) {
      tenants.splice(index, 1);
      saveData();
      renderTenants();
    }
  }

  window.onload = () => {
    ensureAllMonths();
    renderTenants();
  };
</script>

</body>
</html>
